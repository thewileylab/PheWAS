---
title: "createPhenotypes In Database"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{createPhenotypes In Database}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(DBI)
library(RSQLite)
library(PheWAS)
```

## Overview

## Connect to Patient Database
```{r}
## Create DBI connection object to target database
con <- dbConnect(RSQLite::SQLite(), ":memory:")
```

## Upload PheWAS Package Datasets to Target Database
```{r}
## Upload PheWAS package data
dbWriteTable(con, 'phecode_map', PheWAS::phecode_map)
dbWriteTable(con, 'phecode_rollup_map', PheWAS::phecode_rollup_map)
dbWriteTable(con, 'phecode_exclude', PheWAS::phecode_exclude)
```

```{r}
phecode_map <- tbl(con, 'phecode_map')
phecode_map
```

## Create Tidy Phenotypes

```{r, eval=FALSE}
## Define tbl connections to patient data
icd_summary <- tbl(con, 'summarized_patient_diagnoses_info')
id_sex <- tbl(con, 'patient_gener_info')

## Define tbl connections to PheWAS package Datasets
db_phecode_map <- tbl(con, 'phecode_map')
db_phecode_rollup_map <- tbl(con, 'phecode_rollup_map')
db_phecode_exclude <- tbl(con, 'phecode_exclude')

## Create Phenotypes in Database
phenotype_table <- createTidyPhenotypes(id.vocab.code.index = db_icd_summary, 
                                        min.code.count = 2, 
                                        add.phecode.exclusions = T, 
                                        id.sex = db_id_sex, 
                                        vocabulary.map = db_phecode_map, 
                                        rollup.map = db_phecode_rollup_map, 
                                        exclusion.map = db_phecode_exclude
                                        )
```

